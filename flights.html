<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flights</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+3">
</head>
<script type="text/javascript" src="js/scripts.js"></script>
<script type="text/javascript" src="find_flights.js"></script>
<body onload="updateTime(), updateSlider()">
<header>
    <h1>Flights</h1>
</header>
<nav>
    <ul>
        <li><a class="navbar" href="home.html">Home</a></li>
        <li><a class="navbar" href="flights.html">Flights</a></li>
        <li><a class="navbar" href="cruises.html">Cruises</a></li>
        <li><a class="navbar" href="stays.html">Stays</a></li>
        <li><a class="navbar" href="cars.html">Cars</a></li>
        <li><a class="navbar" href="contact.html">Contact Us</a></li>
        <li><a class="navbar" href="cart.html">My Cart</a></li>
    </ul>
</nav>
<div class="container">
    <aside>
        <h2>Sidebar</h2>
        <p id="datetime"></p>
        <div>
            <input type="range" min="8" max="96" value="16" class="slideBox" id="slideRange">
        </div>
        <p>Font size: <span id="fontSize"></span>px</p>

        <p>Background Color</p>
        <input id="colorPicker" type="color" value="#ff0000" style="width:70%;">
        <p id="bgtext">Background color: #FFFFFF</p>
        <br> <br>
        <p class="error" id="error"></p>

    </aside>
    <main>
        <h2>Create Reservation</h2>
        <div id="bodyContent">
            <form>
                <table>
                    <tr>
                        <td>
                            <label>Trip Type <br>
                                <select id="trip-type" onchange="toggleDeparture()">
                                    <option value="one-way">One Way</option>
                                    <option value="round-trip">Round Trip</option>
                                </select>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label> Origin<br>
                                <input type="text" id="origin">
                            </label>
                        </td>
                        <td>
                            <label> Destination<br>
                                <input type="text" id="dest">
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td id="depart">
                            <label for="dept_date"> Departure Date </label><br>
                            <input id="dept_date" type="date">
                        </td>
                        <td style="display: none" id="arrive">
                            <label for="arr_date"> Arrival Date </label><br>
                            <input id="arr_date" type="date">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <img src="assets/flight-passenger-icon.jpg" height="50px" width="50px" alt="passenger-icon"
                                 onclick="showForm()">
                        </td>
                    </tr>
                    <tr id="num_pass_text" style="display: none">
                        <td>
                            <label> Number of Passengers</label>
                        </td>
                    </tr>
                    <tr id="pass_details" style="display:none">
                        <td>
                            <label for="adult">Adults</label>
                            <input type="text" id="adult" size="5">
                        </td>
                        <td>
                            <label for="child">Children</label>
                            <input type="text" id="child" size="5">
                        </td>
                        <td>
                            <label for="infant">Infants</label>
                            <input type="text" id="infant" size="5">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button type="button" onclick="validateEntries()">Submit</button>
                        </td>
                    </tr>
                </table>
            </form>
            <h3>Passenger Details</h3>
            <p id="display"></p>
        </div>

    </main>
</div>

<footer>
    <p>&copy; 2024 Mega Vacation Deals</p>
</footer>
<script>
    function showForm() {
        const pass_txt = document.getElementById("num_pass_text").style.display;
        const num_pass = document.getElementById("pass_details").style.display;
        if (pass_txt === "none" && num_pass === "none") {
            document.getElementById("num_pass_text").style.display = "block"
            document.getElementById("pass_details").style.display = "block"
        } else {
            document.getElementById("num_pass_text").style.display = "none"
            document.getElementById("pass_details").style.display = "none"
        }
    }

    function toggleDeparture() {
        const trip_type = document.getElementById("trip-type").value;
        if (trip_type === "round-trip") {
            document.getElementById("arrive").style.display = "block"
        } else document.getElementById("arrive").style.display = "none"
    }

    function validateEntries() {
        let err_text = "";
        let norm_text = "";
        const num_adult = document.getElementById("adult").value;
        const origin = document.getElementById("origin").value.trim().toLowerCase();
        const dest = document.getElementById("dest").value.trim().toLowerCase();
        const num_child = document.getElementById("child").value;
        const num_infant = document.getElementById("infant").value;
        const city = ['austin', 'san francisco', 'houston', 'dallas', 'san antonio', 'los angeles', 'san diego'];

        // city validation
        const city_regex = new RegExp(`^(${city.join('|')})$`, 'i');
        if (!city_regex.test(origin)) {
            err_text += "Origin must be a city in Texas or California. <br><br>";
        }
        if (!city_regex.test(dest)) {
            err_text += "Destination must be a city in Texas or California. <br><br>";
        }

        // Passenger validation
        const regex_letter = /^([1-4])?$/;
        if ((!num_adult) || !regex_letter.test(num_adult) || !regex_letter.test(num_child)
            || !regex_letter.test(num_infant)) {
            err_text += "Number of passengers in each category cannot be greater than 4! <br><br>";
        }

        // The user must enter check in date, and check out date anytime between
        // Sep 1 2024 to Dec 1st 2024.
        const dep_init = document.getElementById('dept_date').value
        const arr_init = document.getElementById('arr_date').value
        const trip_type = document.getElementById("trip-type").value;
        const date_regex = /^(2024-(09-(0[1-9]|[1-2][0-9]|30)|10-(0[1-9]|[1-2][0-9]|3[01])|11-(0[1-9]|[1-2][0-9]|30)|12-01))$/;
        if (!date_regex.test(dep_init) || (trip_type === "round-trip"
            && !date_regex.test(arr_init))) {
            err_text += "Check-in and Checkout dates must be between Sep 1 2024 to Dec 1st 2024<br><br>";
        }


        if (err_text === "") {
            norm_text += "Trip Type: " + trip_type.value + "<br>"
            norm_text += "Origin: " + origin + "<br>";
            norm_text += "Destination: " + dest + "<br>";
            norm_text += "Departure Date: " + dep_init + "<br>";
            if (trip_type === "round-trip") {
                norm_text += "Arrival Date: " + arr_init + "<br>";
            }
            norm_text += "Number of Passengers: " + "Adults: " + num_adult + ", Children: " + num_child
                + ", Infants: " + num_infant + ".<br><br>"

            document.getElementById("display").innerHTML = norm_text;
            document.getElementById("error").innerHTML = "";
            bookFlight(origin, dest, dep_init);

            // logic to find available XML flights (one-way)
            let available_flights = []
            findFlights(origin, dest, dep_init, arr_init)
                .then(flights => {
                    available_flights = flights;
                })
                .catch(error => {
                    console.error("cannot fetch flights: ", error)
                });


        } else {
            document.getElementById("error").innerHTML = "INPUT ERROR <br><br>" + err_text;
            document.getElementById("display").innerHTML = "";
        }

        function bookFlight(origin, destination, departure_date) {
            console.log("nice!");
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    updateXML(this);
                }
            };
            xmlhttp.open("GET", "xml/data.xml", true);
            xmlhttp.send();
        }

        function updateXML(xml) {
            var x, i, xmlDoc, txt;
            console.log("Nice again!");
            xmlDoc = xml.responseXML;
            let record = xmlDoc.createElement("record");
            record.appendChild(xmlDoc.createElement("origin"));
            record.appendChild(xmlDoc.createElement("destination"));
            record.appendChild(xmlDoc.createElement("departure_date"));

            //
            // txt = "";
            // x = xmlDoc.getElementsByTagName("ARTIST");
            // for (i = 0; i< x.length; i++) {
            //     txt += x[i].childNodes[0].nodeValue + "<br>";
            // }
            // document.getElementById("demo").innerHTML = txt;
        }
    }
</script>


</body>
</html>
