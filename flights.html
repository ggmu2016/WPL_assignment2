<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flights</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+3">
</head>
<script type="text/javascript" src="js/scripts.js"></script>
<script type="text/javascript" src="find_flights.js"></script>
<body onload="updateTime(), updateSlider()">
<header>
    <h1>Flights</h1>
</header>
<nav>
    <ul>
        <li><a class="navbar" href="home.html">Home</a></li>
        <li><a class="navbar" href="flights.html">Flights</a></li>
        <li><a class="navbar" href="cruises.html">Cruises</a></li>
        <li><a class="navbar" href="stays.html">Stays</a></li>
        <li><a class="navbar" href="cars.html">Cars</a></li>
        <li><a class="navbar" href="contact.html">Contact Us</a></li>
        <li><a class="navbar" href="cart.html">My Cart</a></li>
    </ul>
</nav>
<div class="container">
    <aside>
        <h2>Sidebar</h2>
        <p id="datetime"></p>
        <div>
            <input type="range" min="8" max="96" value="16" class="slideBox" id="slideRange">
        </div>
        <p>Font size: <span id="fontSize"></span>px</p>

        <p>Background Color</p>
        <input id="colorPicker" type="color" value="#ff0000" style="width:70%;">
        <p id="bgtext">Background color: #FFFFFF</p>
        <br> <br>
        <p class="error" id="error"></p>

    </aside>
    <main>
        <h2>Create Reservation</h2>
        <div id="bodyContent">
            <form>
                <table>
                    <tr>
                        <td>
                            <label>Trip Type <br>
                                <select id="trip-type" onchange="toggleDeparture()">
                                    <option value="one-way">One Way</option>
                                    <option value="round-trip">Round Trip</option>
                                </select>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label> Origin<br>
                                <input type="text" id="origin">
                            </label>
                        </td>
                        <td>
                            <label> Destination<br>
                                <input type="text" id="dest">
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <td id="depart">
                            <label for="dept_date"> Departure Date </label><br>
                            <input id="dept_date" type="date">
                        </td>
                        <td style="display: none" id="arrive">
                            <label for="arr_date"> Arrival Date </label><br>
                            <input id="arr_date" type="date">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <img src="assets/flight-passenger-icon.jpg" height="50px" width="50px" alt="passenger-icon"
                                 onclick="showForm()">
                        </td>
                    </tr>
                    <tr id="num_pass_text" style="display: none">
                        <td>
                            <label> Number of Passengers</label>
                        </td>
                    </tr>
                    <tr id="pass_details" style="display:none">
                        <td>
                            <label for="adult">Adults</label>
                            <input type="text" id="adult" size="5">
                        </td>
                        <td>
                            <label for="child">Children</label>
                            <input type="text" id="child" size="5">
                        </td>
                        <td>
                            <label for="infant">Infants</label>
                            <input type="text" id="infant" size="5">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button type="button" onclick="validateEntries()">Submit</button>
                        </td>
                    </tr>
                </table>
            </form>
            <h3 id="pass-details" style="display: none;">Passenger Details</h3>
            <p id="display"></p>
            <h3 id="dep-header" style="display: none;">Select Departure Flight</h3>
            <table id="flights-table-departure" style="display: none;">
                <thead>
                <tr>
                    <th>Select</th>
                    <th>ID</th>
                    <th>Origin</th>
                    <th>Destination</th>
                    <th>Departure Date</th>
                    <th>Departure Time</th>
                    <th>Arrival Date</th>
                    <th>Arrival Time</th>
                    <th>Seats</th>
                    <th>Price</th>
                </tr>
                </thead>
                <tbody id="flights-table-departure-body">
                <!-- Flight rows will be added here -->
                </tbody>
            </table>
            <h3 id="arrival-header" style="display: none;">Select Arrival Flight</h3>
            <table id="flights-table-arrival" style="display: none;">
                <thead>
                <tr>
                    <th>Select</th>
                    <th>ID</th>
                    <th>Origin</th>
                    <th>Destination</th>
                    <th>Departure Date</th>
                    <th>Departure Time</th>
                    <th>Arrival Date</th>
                    <th>Arrival Time</th>
                    <th>Seats</th>
                    <th>Price</th>
                </tr>
                </thead>
                <tbody id="flights-table-arrival-body">
                <!-- Flight rows will be added here -->
                </tbody>
            </table>

            <button id="add-to-cart" style="display: none;">Add to Cart</button>


        </div>

    </main>
</div>

<footer>
    <p>&copy; 2024 Mega Vacation Deals</p>
</footer>
<script>
    function showForm() {
        const pass_txt = document.getElementById("num_pass_text").style.display;
        const num_pass = document.getElementById("pass_details").style.display;
        if (pass_txt === "none" && num_pass === "none") {
            document.getElementById("num_pass_text").style.display = "block"
            document.getElementById("pass_details").style.display = "block"
        } else {
            document.getElementById("num_pass_text").style.display = "none"
            document.getElementById("pass_details").style.display = "none"
        }
    }

    function toggleDeparture() {
        const trip_type = document.getElementById("trip-type").value;
        if (trip_type === "round-trip") {
            document.getElementById("arrive").style.display = "block"
        } else document.getElementById("arrive").style.display = "none"
    }

    function validateEntries() {
        let err_text = "";
        let norm_text = "";
        const num_adult = document.getElementById("adult").value;
        const origin = document.getElementById("origin").value.trim().toLowerCase();
        const dest = document.getElementById("dest").value.trim().toLowerCase();
        const num_child = document.getElementById("child").value;
        const num_infant = document.getElementById("infant").value;
        const city = ['austin', 'san francisco', 'houston', 'dallas', 'san antonio', 'los angeles', 'san diego', 'sacramento'];
        let adults = parseInt(num_adult);
        let children = parseInt(num_child);
        let infants = parseInt(num_infant);
        if (!adults){
            adults=0;
        }
        if (!children){
            children =0;
        }
        if (!infants){
          infants =0;
        }

        const seats = adults+children;
        console.log(seats)
        
        // city validation
        const city_regex = new RegExp(`^(${city.join('|')})$`, 'i');
        if (!city_regex.test(origin)) {
            err_text += "Origin must be a city in Texas or California. <br><br>";
        }
        if (!city_regex.test(dest)) {
            err_text += "Destination must be a city in Texas or California. <br><br>";
        }

        // Passenger validation
        const regex_letter = /^([1-4])?$/;
        if ((!num_adult) || !regex_letter.test(num_adult) || !regex_letter.test(num_child)
            || !regex_letter.test(num_infant)) {
            err_text += "Number of passengers in each category cannot be greater than 4! <br><br>";
        }

        // The user must enter check in date, and check out date anytime between
        // Sep 1 2024 to Dec 1st 2024.
        const dep_init = document.getElementById('dept_date').value
        let depDate = null;
        if (dep_init){
            const [year,month,day] = dep_init.split("-").map(Number);
            depDate = new Date(year,month-1,day);
        }

        const arr_init = document.getElementById('arr_date').value
        let arrDate = null;
        if (arr_init){
          const [year,month,day] = arr_init.split("-").map(Number);
          arrDate = new Date(year,month-1,day);
        }

        // validating dates
        const trip_type = document.getElementById("trip-type").value;
        const date_regex = /^(2024-(09-(0[1-9]|[1-2][0-9]|30)|10-(0[1-9]|[1-2][0-9]|3[01])|11-(0[1-9]|[1-2][0-9]|30)|12-01))$/;
        if (!date_regex.test(dep_init) || (trip_type === "round-trip"
            && !date_regex.test(arr_init))) {
            err_text += "Check-in and Checkout dates must be between Sep 1 2024 to Dec 1st 2024<br><br>";
        }

        // if no errors are found
        if (err_text === "") {
            document.getElementById("pass_details").style.display = "block";
            norm_text += "Trip Type: " + trip_type + "<br>"
            norm_text += "Origin: " + origin + "<br>";
            norm_text += "Destination: " + dest + "<br>";
            norm_text += "Departure Date: " + dep_init + "<br>";
            if (trip_type === "round-trip") {
                norm_text += "Arrival Date: " + arr_init + "<br>";
            }
            norm_text += "Number of Passengers: " + "Adults: " + adults + ", Children: " + children
                + ", Infants: " + infants + ".<br><br>"

            document.getElementById("dep-header").style.display="block";
            document.getElementById("display").innerHTML = norm_text;
            document.getElementById("error").innerHTML = "";
            bookFlight(origin, dest, dep_init);

            // logic to find available XML flights (one-way)
            let dep_flight_id = null;
            let available_flights = []
            findFlights(origin, dest, depDate, seats)
                .then(flights => {
                    available_flights = flights;
                    const depFlightsTableBody = document.getElementById('flights-table-departure-body');
                    depFlightsTableBody.innerHTML = ''; //clear previous results
                    if (available_flights.length >0){
                        available_flights.forEach(flight => {
                            const row = document.createElement('tr');

                            // Create the radio button cell
                            const radioCell = document.createElement('td');
                            const radioInput = document.createElement('input');
                            radioInput.type = 'radio';
                            radioInput.name = 'selectedDepFlight';
                            radioInput.value = flight[0];
                            radioInput.required = true;
                            radioCell.appendChild(radioInput);
                            row.appendChild(radioCell);


                          // Adding event listener for changes in selection
                          radioInput.addEventListener('change', ()=>{
                            dep_flight_id = radioInput.value;
                            if (trip_type==="one-way"){
                              document.getElementById("add-to-cart").style.display = "block";
                            }
                            else{
                              document.getElementById("arrival-header").style.display = "block";
                            }
                            console.log(dep_flight_id);
                          })

                            // Create cells for each flight data item
                            const dataCells = [
                                flight[0],  // ID
                                flight[1],  // Origin
                                flight[2],  // Destination
                                flight[3],  // Departure Date
                                flight[4],  // Departure Time
                                flight[5],  // Arrival Date
                                flight[6],  // Arrival Time
                                flight[7],  // Seats
                                flight[8]   // Price
                            ];

                            dataCells.forEach(data => {
                                const cell = document.createElement('td');
                                cell.textContent = data;
                                row.appendChild(cell);
                            });

                            depFlightsTableBody.appendChild(row);
                        });

                        // show the table
                        document.getElementById('flights-table-departure').style.display = 'table';

                    }
                })
                .catch(error => {
                    console.error("cannot fetch flights: ", error)
                });

            let arrival_flight_id = null;
          // Round Trip (duplicate code but whatever)
          if (trip_type==="round-trip") {
            document.getElementById("add-to-cart").style.display = "block";
            findFlights(dest, origin, arrDate, seats)
                    .then(flights => {
                      const arrFlightsTableBody = document.getElementById('flights-table-arrival-body');
                      arrFlightsTableBody.innerHTML = ''; //clear previous results
                      if (flights.length > 0) {
                        flights.forEach(flight => {
                          const row = document.createElement('tr');

                          // Create the radio button cell
                          const radioCell = document.createElement('td');
                          const radioInputArr = document.createElement('input');
                          radioInputArr.type = 'radio';
                          radioInputArr.name = 'selectedArrFlight';
                          radioInputArr.value = flight[0];
                          radioInputArr.required = true;
                          radioCell.appendChild(radioInputArr);
                          row.appendChild(radioCell);

                          // Adding event listener for changes in selection
                          radioInputArr.addEventListener('change', ()=>{
                            arrival_flight_id = radioInputArr.value;
                            document.getElementById("add-to-cart").style.display = "block";
                          })

                          // Create cells for each flight data item
                          const dataCells = [
                            flight[0],  // ID
                            flight[1],  // Origin
                            flight[2],  // Destination
                            flight[3],  // Departure Date
                            flight[4],  // Departure Time
                            flight[5],  // Arrival Date
                            flight[6],  // Arrival Time
                            flight[7],  // Seats
                            flight[8]   // Price
                          ];

                          dataCells.forEach(data => {
                            const cell = document.createElement('td');
                            cell.textContent = data;
                            row.appendChild(cell);
                          });

                          arrFlightsTableBody.appendChild(row);
                        });

                        // show the table
                        document.getElementById('flights-table-arrival').style.display = 'table';

                      }
                    })
                    .catch(error => {
                      console.error("cannot fetch flights: ", error)
                    });

          }

          console.log(trip_type)
          console.log(dep_flight_id)
        // showing the "add to cart" button
          if (trip_type==="one-way" && dep_flight_id){
            console.log("fuk u ")
            document.getElementById("add-to-cart").style.display = "block";
          }
          else if (trip_type==="round-trip" && dep_flight_id && arrival_flight_id) {
            document.getElementById("add-to-cart").style.display = "block";
          }

        } else {
            document.getElementById("error").innerHTML = "INPUT ERROR <br><br>" + err_text;
            document.getElementById("display").innerHTML = "";
        }

        function bookFlight(origin, destination, departure_date) {
            console.log("nice!");
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    updateXML(this);
                }
            };
            xmlhttp.open("GET", "xml/data.xml", true);
            xmlhttp.send();
        }

    function bookFlight(origin, destination, departure_date) {

        // Fetch the existing XML file
        fetch('xml/data.xml')
            .then(response => response.text())
            .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
            .then(xmlDoc => {
                // Create a new record element
                let newRecord = xmlDoc.createElement('record');

                // Create and append origin element
                let newOrigin = xmlDoc.createElement('origin');
                newOrigin.appendChild(xmlDoc.createTextNode(origin));
                newRecord.appendChild(newOrigin);

                // Create and append destination element
                let newDestination = xmlDoc.createElement('destination');
                newDestination.appendChild(xmlDoc.createTextNode(destination));
                newRecord.appendChild(newDestination);

                // Create and append departure_date element
                let newDepartureDate = xmlDoc.createElement('departure_date');
                newDepartureDate.appendChild(xmlDoc.createTextNode(departure_date));
                newRecord.appendChild(newDepartureDate);

                // Append the new record to the dataset
                xmlDoc.documentElement.appendChild(newRecord);

                // Serialize the XML back to a string
                let serializer = new XMLSerializer();
                let updatedXmlString = serializer.serializeToString(xmlDoc);

                // Send the updated XML to the server
                fetch('xml/data.xml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/xml'
                    },
                    body: updatedXmlString
                })
                    .then(response => response.text())
                    .then(data => console.log(data))
                    .catch(error => console.error('Error:', error));
            })
            .catch(error => console.error('Error fetching the XML file:', error));
    }
        function updateXML(xml) {
            var x, i, xmlDoc, txt;
            console.log("Nice again!");
            xmlDoc = xml.responseXML;
            let record = xmlDoc.createElement("record");
            record.appendChild(xmlDoc.createElement("origin"));
            record.appendChild(xmlDoc.createElement("destination"));
            record.appendChild(xmlDoc.createElement("departure_date"));

            //
            // txt = "";
            // x = xmlDoc.getElementsByTagName("ARTIST");
            // for (i = 0; i< x.length; i++) {
            //     txt += x[i].childNodes[0].nodeValue + "<br>";
            // }
            // document.getElementById("demo").innerHTML = txt;
        }
    }
</script>


</body>
</html>
